<!DOCTYPE html>
<html>
<head>
  <title>Next Buses</title>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px 30px 10px 30px;
    }

    h1 {
      margin-bottom: 5px;
    }

    p {
      margin-top: 0;
      font-size: 0.9em;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border-bottom: 2px solid #ddd;
      padding: 20px 10px 20px 10px;
      font-size: 1.75rem;
      text-align: center;
    }

    .small {
      font-size: 0.8em;
      color: gray;
    }

    .realtime {
    color: green;
    font-weight: bold;
    }

    .cancelled-text {
    text-decoration: line-through;
    color: #a00;
    }

  </style>
</head>
<body>
  <h1>Next Departures</h1>
  <p><strong>Last updated:</strong> <span id="last-updated">{{ last_updated }}</span> (Pacific Time)</p>
  <p><strong>Next direction switch in:</strong> <span id="countdown">30</span> seconds</p>

  <table>
    <tbody id="bus-table-body">
      <!-- Rows will be inserted here -->
    </tbody>
  </table>

<script>
  let allData = [];
  let showAlternate = false;
  let countdown = 30; // countdown starts at 30

    async function fetchDataFromAPI() {
    const response = await fetch("/data");
    const data = await response.json();
    allData = data;
    updateTable(); // redraw view

    // Update "Last updated" timestamp here (only on real API refresh)
    const now = new Date();
    const options = {
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        hour12: true,
        timeZone: 'America/Vancouver'
    };
    document.getElementById("last-updated").textContent = now.toLocaleTimeString("en-US", options);
    }


  function updateTable() {
    const tbody = document.getElementById("bus-table-body");
    tbody.innerHTML = "";

    const filtered = allData.filter((entry, index) =>
      (showAlternate ? index % 2 === 1 : index % 2 === 0)
    );

    filtered.forEach(entry => {
      const row = document.createElement("tr");

      const isCancelled = entry.times.some(t => t.cancelled);
      if (isCancelled) row.classList.add("cancelled");

      let html = `
        <td style="font-weight: 700; font-size: 2rem;">${entry.route}</td>
        <td style="min-width: 330px; font-size: 2rem; text-align: left; padding-left: 28px">${entry.direction}</td>
      `;

      entry.times.forEach(t => {
        // Format time (remove seconds)
        let timeDisplay = t.time;

        if (t.real_time) {
          timeDisplay = `<span class="realtime">${timeDisplay}</span>`;
        }

        if (t.cancelled) {
          timeDisplay = `<span class="cancelled-text">${timeDisplay}</span>`;
        }

        html += `<td>${timeDisplay}</td>`;
      });

      row.innerHTML = html;
      tbody.appendChild(row);
    });

    // Update "last updated" time
    const now = new Date();
    const options = {
      hour: 'numeric',
      minute: 'numeric',
      second: 'numeric',
      hour12: true,
      timeZone: 'America/Vancouver'
    };
    document.getElementById("last-updated").textContent = now.toLocaleTimeString("en-US", options);
  }

  // INITIAL DATA FETCH
  fetchDataFromAPI();

  // Update API data every 60 seconds
  setInterval(fetchDataFromAPI, 60000);

  // Toggle direction view every 30 seconds
  setInterval(() => {
    showAlternate = !showAlternate;
    countdown = 30;  // reset countdown
    updateTable();
  }, 30000);

  // Countdown update every second
  setInterval(() => {
    countdown--;
    if (countdown <= 0) countdown = 30;
    document.getElementById("countdown").textContent = countdown;
  }, 1000);
</script>

</body>
</html>
